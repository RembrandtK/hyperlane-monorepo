# Usage

This is from the help output of the hl binary.

## hl

### Summary

As per output of running `hl -h`:

<!-- BEGIN AUTOGENERATED HELP-SHORT -->
<!-- This content is autogenerated and should not be manually changed. -->
<!-- To update this section, run `make`. -->

```
CLI for Hyperlane message dispatch, delivery payment, and querying message logs

Usage: hl [OPTIONS] <URL>

Arguments:
  <URL>  RCP URL for chain to call

Options:
  -k, --key <KEY>                      Private key (optional, if needed to sign), as H256 hex string (64 characters)
      --dispatch                       Perform message dispatch. Requires mailbox, key, and payload
      --pay                            Perform gas payment. Requires paymaster, key, and either a message id or being run with dispatch
      --query <QUERY>                  Query for messages, with criteria in either JSON or CSV format
      --mailbox <MAILBOX>              Mailbox contract address as H160 hex string (40 characters)
      --paymaster <PAYMASTER>          Paymaster contract address as H160 hex string (40 characters)
  -d, --dest <DEST>                    Destination chain identifier. Required for dispatch
  -r, --recipient <RECIPIENT>          Recipient contract address as H160 hex string (40 characters)
  -p, --payload <PAYLOAD>              Hex encoded message payload to send
  -i, --input <INPUT>                  Input file for message payload (bytes) to send
      --confirmations <CONFIRMATIONS>  Number of confirmation blocks to wait for [default: 1]
  -m, --message-id <MESSAGE_ID>        Id of message to pay for
      --gas <GAS>                      Gas to pay on destination chain [default: 100000]
  -s, --start-block <START_BLOCK>      Start block number to search from [default: -1000]
  -e, --end-block <END_BLOCK>          End block number to search to [default: -1]
      --debug                          Do not run; print extracted parameters and exit
  -v, --verbose                        Show verbose output (including transaction logs)
  -h, --help                           Print help (see more with '--help')
  -V, --version                        Print version
```

<!-- END AUTOGENERATED HELP-SHORT -->

### Detail

As per output of running `hl --help`:

<!-- BEGIN AUTOGENERATED HELP -->
<!-- This content is autogenerated and should not be manually changed. -->
<!-- To update this section, run `make`. -->

```
CLI for Hyperlane message dispatch, delivery payment, and querying message logs

Usage: hl [OPTIONS] <URL>

Arguments:
  <URL>
          RCP URL for chain to call

Options:
  -k, --key <KEY>
          Private key (optional, if needed to sign), as H256 hex string (64 characters)

      --dispatch
          Perform message dispatch. Requires mailbox, key, and payload

      --pay
          Perform gas payment. Requires paymaster, key, and either a message id or being run with dispatch

      --query <QUERY>
          Query for messages, with criteria in either JSON or CSV format.

          CSV format (each item is a CSV list): originDomain:senderAddress:destinationDomain:recipientAddress

          CSV example: 11155111,80001:0x05047e42F75eaFf3f6C7a347930F778FB41C5dD0:80001:0x36FdA966CfffF8a9Cdc814f546db0e6378bFef35

          JSON equivalent (outer list is optional if only one item): [{"originDomain":[11155111,80001],"senderAddress":"0x05047e42f75eaff3f6c7a347930f778fb41c5dd0","destinationDomain":80001,"recipientAddress":"0x36fda966cffff8a9cdc814f546db0e6378bfef35"}]

      --mailbox <MAILBOX>
          Mailbox contract address as H160 hex string (40 characters)

      --paymaster <PAYMASTER>
          Paymaster contract address as H160 hex string (40 characters)

  -d, --dest <DEST>
          Destination chain identifier. Required for dispatch

  -r, --recipient <RECIPIENT>
          Recipient contract address as H160 hex string (40 characters)

  -p, --payload <PAYLOAD>
          Hex encoded message payload to send

  -i, --input <INPUT>
          Input file for message payload (bytes) to send.

          (Alternative to --payload, specify one or the other.)

      --confirmations <CONFIRMATIONS>
          Number of confirmation blocks to wait for

          [default: 1]

  -m, --message-id <MESSAGE_ID>
          Id of message to pay for

      --gas <GAS>
          Gas to pay on destination chain

          Will be converted according to gas price and exchange rate

          [default: 100000]

  -s, --start-block <START_BLOCK>
          Start block number to search from.

          If not specified, will search last 100 blocks.

          If negative (-n), will search from latest block + 1 - n.

          [default: -1000]

  -e, --end-block <END_BLOCK>
          End block number to search to.

          If not specified, will search until latest block.

          If negative (-n), will search to latest block + 1 - n.

          [default: -1]

      --debug
          Do not run; print extracted parameters and exit

  -v, --verbose
          Show verbose output (including transaction logs)

  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version
```

<!-- END AUTOGENERATED HELP -->

# Compilation

The build stage has a dependency on compiled contracts in `solidity/`, so before compilation of the CLI you will need to have successfully run:

```
cd path/to/hyperlane-monorepo/solidity
yarn install
npm run build
```

Alternatively you can skip the above step and instead remove the CLI project `rust/cli/build.rs` file and rely on the source files checked into git. There is no other need for `build.rs` and this will work fine.

Once the contracts are compiled (or `build.rs` removed):

```
cd path/to/hyperlane-monorepo/rust/cli
```

You can build and view the documentation:

```
cargo doc --no-deps --open
```

Build the binaries:

```
cargo build
```

If you want to avoid git reporting changes after contract interfaces have been regenerated:

```
cargo fmt
```

Run automated tests:

```
cargo test
```

If source changes are made that change the help output, `make` should be run to update README.md:

```
make
```

# Test Walkthrough

## Introduction to the CLI

The CLI has a fixed parameter of the RPC URL and a number of options depending on action required. Running with the `-h` flag will provide a summary, and `--help` will provide more detailed help.

```
cd path/to/hyperlane-monorepo/rust/cli
cargo build

# You can also use: cargo run -q -- -h
../target/debug/hl -h
```

For the rest of this walkthrough I will presume you stay in the CLI project directory and have compiled the binary.

The simplest way to run the CLI is with just an RPC URL supplied:

```
../target/debug/hl https://rpc.sepolia.org/
```

You should see output as follows:

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
```

The command connected to the chain and retrieved the chain id, reporting chain information based on known Hyperlane domains.

If you also supply the destination chain id:

```
../target/debug/hl https://rpc.sepolia.org/ --dest 80001
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Destination: 80001 Mumbai Ethereum Testnet
```

## Testing using Sepolia and Mumbai testnets

To dispatch messages on Sepolia and Mumbai you will need to use accounts with funds on the respective testnets.

For convenience we will set some environment variables. You need to set the *PKEY and *SENDER variables with the private keys and corresponding addresses that you want to use to sign messages with on Sepolia (prefixed with `S_`) and Mumbai (prefixed with `M_`). These accounts need to have funds to pay for transactions.

For the Mumbai testnet you also need to provide your API key for the RPC URL.

The mailbox and paymaster contract address are sourced from the testnet settings at: https://docs.hyperlane.xyz/docs/resources/addresses

The recipient address is taken from https://docs.hyperlane.xyz/docs/apis-and-sdks/messaging-api/send. It doesn't matter what you put for the these tests, as they are only seeking to verify that a message is successfully dispatched and paid for.

```
export S_PKEY=...
export S_SENDER=...
export S_ID=11155111
export S_URL=https://rpc.sepolia.org/
export S_MBOX=0xCC737a94FecaeC165AbCf12dED095BB13F037685
export S_PAYM=0xF987d7edcb5890cB321437d8145E3D51131298b6
export S_RECIPIENT=0x36FdA966CfffF8a9Cdc814f546db0e6378bFef35

export M_PKEY=...
export M_SENDER=...
export M_ID=80001
export M_URL=https://polygon-mumbai.g.alchemy.com/v2/<your API key>
export M_MBOX=0xCC737a94FecaeC165AbCf12dED095BB13F037685
export M_PAYM=0xF90cB82a76492614D07B82a7658917f3aC811Ac1
export M_RECIPIENT=0x36FdA966CfffF8a9Cdc814f546db0e6378bFef35
```

To dispatch a message use the `--dispatch` flag. This calls the dispatch method of the Mailbox contract address supplied. Note that this does not pay for delivery on the destination chain (that will be shown later).

```
../target/debug/hl $S_URL --key $S_PKEY --mailbox $S_MBOX --dispatch --dest $M_ID --recipient $M_RECIPIENT --payload 0xC0FFEE
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Destination: 80001 Mumbai Ethereum Testnet
Dispatch in block 3777198, tx hash: 0x6d7f875b01814d761cbca053761d21dd423e79e3d37b02f82cd2a3125b8537bd
  Message ID: 0xb587dcf2a22ca926653191d8d413715eafeaffdd4f338b07e066b74eb9dc058a
```

The details will be different for your local run.

You can query to see which messages have been recently dispatched by you:

```
../target/debug/hl $S_URL --mailbox $S_MBOX --query :$M_SENDER::
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Querying logs from block 3776200 to 3777199.

Dispatch in block 3777198 to: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x6d7f875b01814d761cbca053761d21dd423e79e3d37b02f82cd2a3125b8537bd
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
  ID       : 0xb587dcf2a22ca926653191d8d413715eafeaffdd4f338b07e066b74eb9dc058a
```

You can also go to https://sepolia.etherscan.io/, filter by the address corresponding to the private key that you signed with, and you should see the dispatched message (you can identify it by the transaction hash).

Using the message ID you can now pay for delivery on the destination chain:

```
../target/debug/hl $S_URL --paymaster $S_PAYM --key $S_PKEY --pay --dest $M_ID --message-id <message id>
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Destination: 80001 Mumbai Ethereum Testnet
Quote for 10000 gas on destination chain: 1985911200000000
Pay in block 3777233, hash: 0x6c05a89d1a0f1e2caa8c646a03ff8b0df9fd9ffdd3078fdf9172a45324ba7f7c
```

Using the CLI, you can also perform a query on Mailbox logs. First run the command with the --debug flag, and it will show you the parsed parameters and exit. You can use this flag to confirm how the criteria supplied are interpreted.

```
../target/debug/hl $S_URL --mailbox $S_MBOX --query :$S_SENDER::$M_RECIPIENT --debug
```

```
Params {
    rpc_url: "https://rpc.sepolia.org/",
    verbose: false,
    debug: true,
    key: None,
    dispatch: false,
    pay: false,
    deploy_mock: false,
    mailbox_address: Some(
        0xcc737a94fecaec165abcf12ded095bb13f037685,
    ),
    dest_id: None,
    recipient_address: None,
    payload: None,
    paymaster_address: None,
    msg_id: None,
    gas: 10000,
    matching_list: MatchingList(
        Some(
            [
                MatchItem {
                    origin_domain: Wildcard,
                    sender_address: Enumerated(
                        [
                            0x00000000000000000000000005047e42f75eaff3f6c7a347930f778fb41c5dd0,
                        ],
                    ),
                    destination_domain: Wildcard,
                    recipient_address: Enumerated(
                        [
                            0x00000000000000000000000036fda966cffff8a9cdc814f546db0e6378bfef35,
                        ],
                    ),
                },
            ],
        ),
    ),
    start_block: -1000,
    end_block: -1,
}
```

Now run without `--debug`:

```
../target/debug/hl $S_URL --mailbox $S_MBOX --query :$S_SENDER::$M_RECIPIENT
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Querying logs from block 3776422 to 3777421.

Dispatch in block 3777198 to: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x6d7f875b01814d761cbca053761d21dd423e79e3d37b02f82cd2a3125b8537bd
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
  ID       : 0xb587dcf2a22ca926653191d8d413715eafeaffdd4f338b07e066b74eb9dc058a
```

You can run it the other way around, you will need to have setup the Mumbai URL with your own API key:

```
../target/debug/hl $M_URL --mailbox $M_MBOX --key $M_PKEY --dispatch --dest $S_ID --recipient $S_RECIPIENT -p 0xC0FFEE
```

```
Connecting to: https://polygon-mumbai.g.alchemy.com/v2/aPLVVNblPlrQieWUV3je3G4Ro9KPsZxi
Origin: 80001 Mumbai Ethereum Testnet
Destination: 11155111 Sepolia Ethereum Testnet
Dispatch in block 37326816, tx hash: 0xe927245bc2b3f1709745ef43323feb8c9edd5637e3308f74bca43c9fcbb46e36
  Message ID: 0x8eaaecdf095dea02f1e9ef0a365e8150ad23d32c8567f4e82b353fe8d75bed33
```

Now lets dispatch and pay for delivery of a message using one command:

```
../target/debug/hl $M_URL --mailbox $M_MBOX --key $M_PKEY --dispatch --dest $S_ID --recipient $S_RECIPIENT -p 0xC0FFEE --paymaster $M_PAYM --pay --gas 100000
```

```
Connecting to: https://polygon-mumbai.g.alchemy.com/v2/aPLVVNblPlrQieWUV3je3G4Ro9KPsZxi
Origin: 80001 Mumbai Ethereum Testnet
Destination: 11155111 Sepolia Ethereum Testnet
Dispatch in block 37326959, tx hash: 0x0cd5ff87dc5c0970f3015208166f13b19e772e841e3a786815edc001d47c8486
  Message ID: 0x1d95459b7d654dc9de9b82466e43d5412982b7c1af8aa261770903306a9c9d2a
Quote for 100000 gas on destination chain: 8441420000000000
Pay in block 37326962, hash: 0x532d9b60d49f809d3638de8f63e3cf34714865a8720028cfe3ac90c7b27fb5d4
```

Note that the message id was automatically picked up from the dispatch action.

Run a query again:

```
../target/debug/hl $M_URL --mailbox $M_MBOX --query :$M_SENDER::$S_RECIPIENT
```

```
Connecting to: https://polygon-mumbai.g.alchemy.com/v2/aPLVVNblPlrQieWUV3je3G4Ro9KPsZxi
Origin: 80001 Mumbai Ethereum Testnet
Querying logs from block 37326004 to 37327003.

Dispatch in block 37326816 to: 11155111 Sepolia Ethereum Testnet
  Tx hash  : 0xe927245bc2b3f1709745ef43323feb8c9edd5637e3308f74bca43c9fcbb46e36
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
  ID       : 0x8eaaecdf095dea02f1e9ef0a365e8150ad23d32c8567f4e82b353fe8d75bed33

Dispatch in block 37326959 to: 11155111 Sepolia Ethereum Testnet
  Tx hash  : 0x0cd5ff87dc5c0970f3015208166f13b19e772e841e3a786815edc001d47c8486
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
  ID       : 0x1d95459b7d654dc9de9b82466e43d5412982b7c1af8aa261770903306a9c9d2a
```

Now query on Sepolia again:

```
../target/debug/hl $S_URL --mailbox $S_MBOX --query :$S_SENDER::$M_RECIPIENT
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Querying logs from block 3776477 to 3777476.

Dispatch in block 3777198 to: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x6d7f875b01814d761cbca053761d21dd423e79e3d37b02f82cd2a3125b8537bd
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
  ID       : 0xb587dcf2a22ca926653191d8d413715eafeaffdd4f338b07e066b74eb9dc058a

Process in block 3777469 from: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x74e5ea0b6a3faccef1582b7c1409a38d50c7b8a2dc501942bbe50aa3469b3d89
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
```

Notice that the last log entry is not a Dispatch but a Process. The query command performed two underlying queries (ordering and deduplicating combined results, although in this case there would be no duplicates). One query on Dispatch events, and one on Process events.

The last Process item was relayed from the Mumbai mailbox to the Sepolia mailbox. Hyperlane in action! Note that relaying speed is variable, and you might not have to wait for the message to appear.

I suggest exploring the CLI options using --help.

There are obvious ways to enhance the tool that I did not have time for:

1. Consider reading ProcessId logs to translate from transaction hashes to message ids.
2. Also read (and link via message id) the GasPayment events of gas paymasters.
3. Support reading from both origin and destination chains from one query invocation and, by reading all event types and linking by message id, report the status of transactions (dispatched -> paid for -> processed).
4. Add reading of ReceivedMessage events of the TestRecipient contract, and/or other relevant events.
5. Consider if other information should be (optionally) extracted, for example the message sent.
6. There are a lot of rough edges (minimal unit tests, incomplete documentation, code to be cleanup up and refactored).

Note that the tool supports providing multiple queries at once. For example for anything sent by $SENDER or to $RECIPIENT:

```
../target/debug/hl $S_URL --mailbox $S_MBOX --query :$S_SENDER:: --query :::$S_RECIPIENT
```

Using `--debug` you can see this results in two separate MatchItems. Underlying this, 4 (2 MatchItems, with a Dispatch and Process for each) log queries are made that are collectively ordered and deduplicated to achieve the combination of filtering on chain and convenience of seeing items only once and in order.

This design does have the tradeoff of making many queries, and could be done in much less code with a simpler approach that is likely 'good enough' in practice.

An explicit anything query works (at least on Sepolia, queries that are too open might be rejected on some testnets) and shows there is other mailbox activity:

```
../target/debug/hl $S_URL --mailbox $S_MBOX --query :::
```

```
Connecting to: https://rpc.sepolia.org/
Origin: 11155111 Sepolia Ethereum Testnet
Querying logs from block 3776524 to 3777523.

Process in block 3776525 from: 43113 Fuji Ethereum Testnet
  Tx hash  : 0xa6c621502a43443499f289f9fbfaaa03628c1283fc839c444c2de2b55ddce43e
  Sender   : 0x5da3b8d6f73df6003a490072106730218c475aad
  Recipient: 0x5d56b8a669f50193b54319442c6eee5edd662381

Dispatch in block 3776615 to: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x105cb163f5a7fa387c26abc89defdf3aea734d025a6f7ac28b737b960b8cc3b0
  Sender   : 0x5d56b8a669f50193b54319442c6eee5edd662381
  Recipient: 0x1a4d8a5ed6c93af828655e15c44eee2c2851f0d6
  ID       : 0xf10432aa9a0baffc65a3c8c77158f77fdaf6282ab03ba88a7a5983cb07a1ebe3

Process in block 3777075 from: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x8745733c9b3bf16cc71081e6db2b9dd56fa6002c787d44d34e572373def97787
  Sender   : 0x1a4d8a5ed6c93af828655e15c44eee2c2851f0d6
  Recipient: 0x5d56b8a669f50193b54319442c6eee5edd662381

Dispatch in block 3777161 to: 97 BinanceSmartChainTestnet Ethereum Testnet
  Tx hash  : 0x92f27498f589de05347a3b18ff57211780e0989f5c3e533b13698a10d3d2380d
  Sender   : 0x5d56b8a669f50193b54319442c6eee5edd662381
  Recipient: 0xe09bf59dca6e622efc33f6fbd8ef85de45233388
  ID       : 0x34cc73325cb382cc25cee4cbf3874fdd886e83f1262bca3e0865b6c406a90b07

Dispatch in block 3777198 to: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x6d7f875b01814d761cbca053761d21dd423e79e3d37b02f82cd2a3125b8537bd
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
  ID       : 0xb587dcf2a22ca926653191d8d413715eafeaffdd4f338b07e066b74eb9dc058a

Process in block 3777463 from: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0xb93aa02b54f1a1a73b5981d54a84920b6099865d6f7662b0c283d48e86ec6575
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35

Process in block 3777469 from: 80001 Mumbai Ethereum Testnet
  Tx hash  : 0x74e5ea0b6a3faccef1582b7c1409a38d50c7b8a2dc501942bbe50aa3469b3d89
  Sender   : 0x05047e42f75eaff3f6c7a347930f778fb41c5dd0
  Recipient: 0x36fda966cffff8a9cdc814f546db0e6378bfef35
```
